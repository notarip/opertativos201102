#!/bin/bashfunction verifica_entorno{#verificacion de variables de ambiente	#devuelve $ENTORNO = S si esta ok#$ARRIDIR, $PEPRADIR, $RECHADIR, $BINDIR		ENTORNO = "S"			if [ -z $ARRIDIR ];then		ENTORNO = "N"	fi	if [ -z $PREPADIR ];then		ENTORNO = "N"	fi	if [ -z $RECHADIR ];then		ENTORNO = "N"	fi	if [ -z $BINDIR ];then		ENTORNO = "N"	fi}function verifica_instancia{#verifica si existe otra instancia del proceso tanto de detectar como de sumar#viene en $1#devuelve $INSTANCIA = S si existe una instancia en ejecucion		$INSTANCIA = N	ps | grep .*$1.* > /dev/null	if [ $? -eq 0 ];then			$INSTANCIA = S	fi}function recupera_sleep_time{	#recupera del archivo de conf el tiempo de sleep	#en la variable TSLEEP	#por ahi ya viene seteado, esperar a que se defina eso}function recupera_archivo_nuevo{#verifica y recupera del arrdir el primero que encuentreARCH=''HAY_NUEVO=N 		for ARCH in *	do			$ARCH		break	done	if [ -n $ARCH ];then				HAY_NUEVO = S	fi}function verifica_archivo{	#verifica que el nombre del archivo sea valido y 	#separa en dos variables encuestador y fecha	#llama a verifica_maestro_encuestadores	echo $1 | grep '^[^.]*\.[^.]*$' > /deb/null		if [ $? -eq 0 ]			#cumple con la regular		verifica_maestro_encuestadores $1		else		#no cumple		ARC_VALIDO=N	fi}function verifica_maestro_encuestadores{	#busca al encuestador en el mae y verifica las fechas	#$DATAMAE	#encuestadores.mae	ENCUESTADOR=$(echo $1 | cut -d . --field=1)	FECHA=$(echo $1 | cut -d . --field=2)		if [ -e $DATAMAE/encuestadores.mae ];then		#el archivo existe	else		#TODO ver que hacer, para mi es error fatal				fi		REG=$(cat $DATAMAE/encuestadores.mae | grep ".*$ENCUESTADOR.*")			if [ -n $REG ];then			FECHAD=$(echo $REG | cut -d , -field=4)		FECHAA=$(echo $REG | cut -d , -field=5)		if [ $FECHAD -le $FECHA ] && [ $FECHAA -ge $FECHA ];then			ARC_VALIDO=S				else			ARC_VALIDO=N				fi	else		ARC_VALIDO=S	fi}function mover_archivo_ok{	#mueve el archivo al folder de preparados	#generando el log correspondiente	llama_mover $ARRIDIR/$ARCH $PREPADIR}function mover_archivo_rech{	#mueve el archivo al folder de rechazados	#generando el log correspondiente	llama_mover $ARRIDIR/$ARCH $RECHADIR}functio llama_mover{	#TODO revisar llamada	mover $1 $2		}function llama_a_sumar{	#llama al componente sumar siempre que no este activo	#para lo que usa verifica_instancia verifica_instancia 'sumarC'		verifica_instancia 'sumarC'	if [ $INSTANCIA -ne S ]		#llamada a sumarC en background	fi	}function terminar{	#como termina cuando lo stopean}#catcheo de las señalestrap terminar SIGTERM#programa principalverifica_entorno if [ $ENTORNO -ne S ];then	exit $ERR_ENTORNOfiverifica_instancia 'detectarC'if [ $INSTANCIA -eq S ]	exit $ERR_INSTANCIAfi#TSLEEPrecupera_sleep_timewhile [ 1 -eq 2 ];do	recupera_archivo_nuevo	while [ $HAY_NUEVO -eq S ];do		verifica_archivo $ARCH				if [ $ARC_VALIDO -eq S ];then			mover_archivo_ok		else			mover_archivo_rech		fi		recupera_archivo_nuevo			done		llama_a_sumar		sleep $TSLEEPdone